# 配置文件管理最佳实践

## 🎯 方案概述

使用 **环境变量 + Profile配置** 的方式，实现：
- ✅ 敏感信息（密码）不写死在配置文件中
- ✅ 不同环境使用不同配置
- ✅ 配置与代码分离，更安全
- ✅ 便于部署和维护

---

## 📁 配置文件结构

```
xl-im-backend/xl-im-admin/src/main/resources/
├── application.yml              # 公共配置
├── application-dev.yml          # 开发环境配置
├── application-prod.yml         # 生产环境配置（使用环境变量）
└── logback-spring.xml           # 日志配置

/www/wwwroot/xl-im/              # 服务器目录
├── xl-im-admin-1.0.0.jar        # JAR文件
├── .env                         # 环境变量文件（不提交到代码仓库）
├── .env.example                 # 环境变量示例文件
├── start.sh                     # 启动脚本（自动加载.env）
└── logs/                        # 日志目录
```

---

## 🔧 配置方式

### 方式一：使用 .env 文件（推荐）

**优点：**
- 敏感信息不会写入代码
- 不同服务器可以有不同的配置
- .env 文件不提交到Git，更安全

**步骤：**

1. **在服务器上创建 .env 文件**

```bash
cd /www/wwwroot/xl-im
cp .env.example .env
nano .env
```

2. **编辑 .env 文件，填入实际配置**

```bash
# 数据库配置
DB_URL=jdbc:mysql://localhost:3306/xl_im?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true
DB_USERNAME=root
DB_PASSWORD=你的实际MySQL密码

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DATABASE=0

# MongoDB配置
MONGODB_URI=mongodb://localhost:27017/xl_im
MONGODB_DATABASE=xl_im

# 文件上传配置
UPLOAD_PATH=/www/wwwroot/uploads
UPLOAD_BASE_URL=http://159.75.243.81/uploads
```

3. **设置文件权限（保护敏感信息）**

```bash
chmod 600 .env  # 只有所有者可以读写
```

4. **启动服务**

```bash
./start.sh
```

启动脚本会自动加载 `.env` 文件中的环境变量。

---

### 方式二：直接在启动命令中设置环境变量

**适合：** Docker部署或临时测试

```bash
export DB_PASSWORD=你的密码
export DB_USERNAME=root
./start.sh
```

---

### 方式三：系统环境变量

**在 `/etc/profile` 或 `/etc/environment` 中设置：**

```bash
export DB_PASSWORD=你的密码
export DB_USERNAME=root
export REDIS_PASSWORD=redis密码
```

---

## 🔐 安全建议

### 1. .env 文件安全

```bash
# 设置正确的权限
chmod 600 .env

# 确保 .env 不会被提交到Git
echo ".env" >> .gitignore
```

### 2. 不同环境使用不同配置

- **开发环境**：密码可以直接写在配置文件中（仅本地）
- **测试环境**：使用测试数据库密码
- **生产环境**：必须使用环境变量，密码不能写死在配置文件中

---

## 📝 配置文件说明

### application.yml（公共配置）
- 包含所有环境的公共配置
- 不使用敏感信息

### application-dev.yml（开发环境）
```yaml
spring:
  profiles: dev
  datasource:
    username: root
    password: 123456  # 开发环境可以直接写
```

### application-prod.yml（生产环境）
```yaml
spring:
  profiles: prod
  datasource:
    # 使用环境变量，不写死密码
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:}  # 必须通过环境变量设置
```

---

## 🚀 部署流程

### 首次部署

1. **打包应用**
```bash
mvn clean package -DskipTests
```

2. **上传到服务器**
- 上传 JAR 文件
- 上传脚本文件

3. **创建环境变量文件**
```bash
cd /www/wwwroot/xl-im
# 创建 .env 文件并填入配置
nano .env
chmod 600 .env
```

4. **启动服务**
```bash
./start.sh
```

### 更新部署

1. 重新打包并上传 JAR 文件
2. 重启服务：`./restart.sh`
3. **无需修改配置文件**（.env文件保持不变）

---

## 🔄 多环境管理

### 开发环境
```bash
# 本地开发，使用dev profile
java -jar -Dspring.profiles.active=dev xl-im-admin-1.0.0.jar
```

### 测试环境
```bash
# 测试服务器，使用test profile
export SPRING_PROFILES_ACTIVE=test
./start.sh
```

### 生产环境
```bash
# 生产服务器，使用prod profile（默认）
./start.sh
```

---

## 📋 .env 文件模板

已创建 `.env.example` 文件作为模板，包含所有可配置的环境变量。

---

## ✅ 优势总结

1. **安全性**：密码不写死在代码中
2. **灵活性**：不同环境可以轻松切换
3. **可维护性**：配置集中管理
4. **版本控制**：.env不提交到Git，避免泄露
5. **部署简单**：上传JAR和.env即可

